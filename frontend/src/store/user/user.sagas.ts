import { PayloadAction } from "@reduxjs/toolkit";
import { call, put, select, takeEvery } from "redux-saga/effects";
import { ApiError } from "../../api/api";
import { OrdersApi } from "../../api/orders";
import { UserApi } from "../../api/user";
import { ERROR_SNACKBAR } from "../../App";
import { uiSliceActions } from "../ui/ui.slice";
import { USER_ACTIONS } from "./user.actions";
import { selectIsLoggedIn } from "./user.selectors";
import { Order, User, userSliceActions } from "./user.slice";

function* login(action: PayloadAction<{ email: string; password: string }>) {
  try {
    const result: User & { jwt: string } = yield UserApi.login(action.payload);
    localStorage.setItem("userData", JSON.stringify(result));
    yield put(userSliceActions.login(result));
    const orders: Array<Order> = yield call(OrdersApi.getAll, result.jwt);
    yield put(userSliceActions.putOrders(orders));
  } catch (e) {
    yield put(uiSliceActions.setUiData({
      uiElementName: ERROR_SNACKBAR,
      data: {
        show: true,
        msg: (e as Error).message,
      }
    }));
  }
}

function* watchLogin() {
  yield takeEvery(USER_ACTIONS.LOGIN, login);
}

function* signup(action: PayloadAction<{ email: string; password: string }>) {
  try {
    yield UserApi.signup(action.payload);
    yield login(action);
  } catch (e) {
    yield put(uiSliceActions.setUiData({
      uiElementName: ERROR_SNACKBAR,
      data: {
        show: true,
        msg: (e as Error).message,
      }
    }));
  }
}

function* watchSignup() {
  yield takeEvery(USER_ACTIONS.SIGNUP, signup);
}

function* checkLogin() {
  try {
    const isLogged: boolean = yield select(selectIsLoggedIn);
    const userData = localStorage.getItem("userData");
    if (!isLogged && userData) {
      const parsed: User & { jwt: string } = JSON.parse(userData);
      yield put(userSliceActions.login(parsed));
      const orders: Array<Order> = yield call(OrdersApi.getAll, parsed.jwt);
      yield put(userSliceActions.putOrders(orders));
    }
  } catch (e) {
    if(e instanceof ApiError && e.httpCode === 401){
      localStorage.clear();
      yield put(userSliceActions.logout());
    }else{
      yield put(uiSliceActions.setUiData({
        uiElementName: ERROR_SNACKBAR,
        data: {
          show: true,
          msg: (e as Error).message,
        }
      }));
    }
  }
}

function* watchCheckLogin() {
  yield takeEvery(USER_ACTIONS.CHECKLOGIN, checkLogin);
}

const userSagas = [watchLogin, watchSignup, watchCheckLogin];
export default userSagas;
