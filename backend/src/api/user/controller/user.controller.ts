import {
  BadRequestException,
  Body,
  Controller,
  Post,
  Res,
} from '@nestjs/common';
import { ApiBody } from '@nestjs/swagger';
import { UserApiBody } from '../../../model/user/add.model';
import { ApiResponse } from '../../../model/response.model';
import { UserService } from '../service/user.service';
import { sign as jwtSign } from 'jsonwebtoken';
import { Response } from 'express';
import { UserEntity } from '../entity/user.entity';

@Controller('user')
export class UserController {
  constructor(private readonly userService: UserService) {}

  @ApiBody({
    type: UserApiBody,
  })
  @Post('signup')
  async createUser(
    @Body() body: UserApiBody,
  ): Promise<ApiResponse<Partial<UserEntity>>> {
    if (!body.user || !body.password) {
      throw new BadRequestException('Bad data.');
    }
    if (body.user.length < 5) {
      throw new BadRequestException(
        'Username should be longer than 5 characters.',
      );
    }
    if (body.password.length < 5) {
      throw new BadRequestException(
        'Password should be longer than 5 characters.',
      );
    }
    if (body.password === body.user) {
      throw new BadRequestException('Username and password should differ');
    }
    const userExist = await this.userService.findByEmail(body.user);
    if (userExist) {
      throw new BadRequestException('User already exists.');
    }
    return {
      code: 200,
      msg: 'Account created',
      data: await this.userService.createOrUpdate(body.user, body.password),
    };
  }

  @ApiBody({
    type: UserApiBody,
  })
  @Post('login')
  async login(@Body() body: UserApiBody, @Res() response: Response) {
    const login = await this.userService.login(body.user, body.password);
    const jwtToken = jwtSign(
      {
        user: login.user,
        userId: login.id,
      },
      process.env.JWT_SECRET ?? 'test',
      { expiresIn: '1h' },
    );
    const responseData: ApiResponse<{
      user: string;
      jwt: string;
      id: number;
      isAdmin: boolean;
    }> = {
      code: 200,
      msg: 'ok',
      data: {
        jwt: jwtToken,
        user: login.user,
        id: login.id,
        isAdmin: login.isAdmin,
      },
    };
    return response
      .setHeader('authorization', 'Bearer: ' + jwtToken)
      .json(responseData);
  }
}
